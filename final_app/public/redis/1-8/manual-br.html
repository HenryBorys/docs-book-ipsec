<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <!-- Always force latest IE rendering engine or request Chrome Frame -->
  <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">

  <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,300italic,400italic,400,600' rel='stylesheet' type='text/css'>
  <!-- Use title if it's in the page YAML frontmatter -->
  <title>
      Manual Backup and Restore of Redis for PCF |
    Pivotal Docs
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="/stylesheets/all.css" rel="stylesheet" media="screen, print" />
  <link href="/stylesheets/print.css" rel="stylesheet" media="print" />
  <link href='/images/favicon.ico' rel='shortcut icon'>

  <script src="/javascripts/all.js"></script>
  
<script type="text/javascript">
  if (window.location.host === 'docs.pivotal.io') {
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-39702075-1']);
    _gaq.push(['_setDomainName', 'pivotal.io']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script');
      ga.type = 'text/javascript';
      ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(ga, s);
    })();
  }
</script>

<script type="text/javascript">
  var blackList = ['acceptance'];

  blackList.forEach(function(blackListedEnv) {
    if (document.URL.indexOf(blackListedEnv) > -1 && blackListedEnv != "") {
      $('head').append('<meta name="hashtag" content="PivotalMoment">');
    }
  });
</script>

<!-- CrazyEgg Tracking Script -->
  <script type="text/javascript">
  setTimeout(function(){var a=document.createElement("script");
  var b=document.getElementsByTagName("script")[0];
  a.src=document.location.protocol+"//script.crazyegg.com/pages/scripts/0055/2990.js?"+Math.floor(new Date().getTime()/3600000);
  a.async=true;a.type="text/javascript";b.parentNode.insertBefore(a,b)}, 1);
  </script>

<!-- Munchkin Marketo Script -->
<script type="text/javascript">
  (function() {
    var didInit = false;

    function initMunchkin() {
      if (didInit === false) {
        didInit = true;
        Munchkin.init('625-IUJ-009');
      }
    }

    var s = document.createElement('script');
    s.type = 'text/javascript';
    s.async = true;
    s.src = document.location.protocol + '//munchkin.marketo.net/munchkin.js';
    s.onreadystatechange = function() {
      if (this.readyState == 'complete' || this.readyState == 'loaded') {
        initMunchkin();
      }
    };
    s.onload = initMunchkin;
    document.getElementsByTagName('head')[0].appendChild(s);
  })();
</script>

</head>

<body class="redis redis_1-8 redis_1-8_manual-br has-subnav">

<div class="viewport">
  <div class='wrap'>
    <script type="text/javascript">
      document.domain = "pivotal.io";
    </script>

      <header class="global-header header header-layout js-bar-links">
    <a class="pivotal-logo" href="/">
    </a>
    <a href="/" class="global-header-title">
      <span class="title-deemph">Pivotal</span> Documentation
    </a>
    <div class="btn-menu" data-behavior="MenuMobile"></div>
    <div class="header-links">
      <div class="header-item">
        <a href="https://network.pivotal.io/">Downloads</a>
      </div>
      <div class="header-item">
        <a href="http://support.pivotal.io" target="_blank">Support</a>
      </div>

      <div class="header-item embedded-searchbar">
          <form method="get" action="/search">
            <input name="q" placeholder="Search Redis 1.8" class="search-box" />
            <input type="hidden" name="product_name" value="Pivotal Redis" />
              <input type="hidden" name="product_version" value="1.8"/>
          </form>
      </div>
      
    </div>
  </header>



    <div class="container">

      <!--googleoff: index-->
      <div id="sub-nav" class="js-sidenav nav-container" role="navigation">
  <a class="sidenav-title" data-behavior="SubMenuMobile">
    Doc Index
  </a>
  <div class="nav-content">
    <ul>


      <li class="has_submenu expanded">
        <a href="/redis/1-8/index.html">About Redis for PCF</a>
        <ul>
          <li>
            <a href="/redis/1-8/minor-overview.html">Overview of Redis for PCF v.1.7</a>
          </li>
          <li>
            <a href="/redis/1-8/release.html">Release Notes</a>
          </li>
          <li>
            <a href="/redis/1-8/architecture.html#config">How Redis for PCF Configures Redis</a>
          </li>
          <li>
            <a href="/redis/1-8/architecture.html#plans">Service Plans</a>
          </li>
          <li>
            <a href="/redis/1-8/architecture.html#architecture">Architecture</a>
          </li>
          <li>
            <a href="/redis/1-8/architecture.html#lifecycle">Lifecycle</a>
          </li>
          <li>
            <a href="/redis/1-8/recommended.html">Recommended Usage and Limitations</a>
          </li>
          <li>
            <a href="/redis/1-8/security.html">Security</a>
          </li>
        </ul>
      </li>

      <li class="has_submenu expanded">
        <a href="/redis/1-8/maintain.html">Operator Guide</a>
        <ul>
          <li>
            <a href="/redis/1-8/installing.html">Installing Redis</a>
          </li>
          <li>
            <a href="/redis/1-8/installing.html#service-plans">Configuring Service Plans</a>
          </li>
          <li>
            <a href="/redis/1-8/installing.html#syslog">Configuring Syslog Output</a>
          </li>
          <li>
            <a href="/redis/1-8/installing.html#backup">Configuring Automated Backups</a>
          </li>
          <li>
            <a href="/redis/1-8/installing.html#azs">Networks, Security, and Assigning AZs</a>
          </li>          
          <li>
            <a href="/redis/1-8/installing.html#validation">Validating Install with Smoke Tests</a>
          </li>
          <li>
            <a href="/redis/1-8/manual-br.html#create">Creating Manual Backups</a>
          </li>
          <li>
            <a href="/redis/1-8/manual-br.html#restore">Restoring from Backups</a>
          </li>
          <li>
            <a href="/redis/1-8/monitoring.html">Monitoring and Metrics</a>
          </li>
          <li>
            <a href="/redis/1-8/installing.html#upgrades">Upgrading Redis for PCF</a>
          </li>
          <li>
            <a href="/redis/1-8/installing.html#uninstall">Uninstalling Redis for PCF</a>
          </li>
          <li>
            <a href="/redis/1-8/troubleshooting.html">Troubleshooting</a>
          </li>
        </ul>
      </li>

      <li class="has_submenu expanded">
        <a href="/redis/1-8/appdevs.html">Application Developer Guide</a>
        <ul>
          <li>
            <a href="/redis/1-8/appdevs.html#getting-started">Getting Started</a>
          </li>
          <li>
            <a href="/redis/1-8/architecture.html#service-plans">Service Plans</a>
          </li>
          <li>
            <a href="/redis/1-8/using.html#create">Creating a Redis Service Instance</a>
          </li>
          <li>
            <a href="/redis/1-8/using.html#bind">Binding an App to a Service Instance</a>
          </li>
          <li>
            <a href="/redis/1-8/using.html#delete">Deleting a Service Instance</a>
          </li>
          <li>
            <a href="/redis/1-8/recommended.html">Recommended Usage and Limitations</a>
          </li>
          <li>
            <a href="/redis/1-8/redisconf.html">Sample Redis Configuration</a>
          </li>
        </ul>
      </li>
    </ul>
  </div>
</div><!--end of sub-nav-->





      <!--googleon: index-->

      <main class="content content-layout" id="js-content" role="main">
        <a id="top"></a>
          <div class="local-header title-container">
    <div class="local-header version-info">
      LATEST VERSION: 1.8 - <a href="">CHANGELOG</a>
    </div>
    <div class="local-header local-title clearfix">
      <img src="/images/cloud_rings.png">
      <span class="local-header-title">Pivotal Redis
      </span>
      <span class="local-header local-version header-dropdown">
        <a class="local-header header-dropdown-link">v1.8</a>
        <span class="local-header header-dropdown-content">
          <ul>
                <li>
                    <a href="http://docs.pivotal.io/redis/1-7/manual-br.html">v1.7</a>
                </li>
                <li>
                    <a href="http://docs.pivotal.io/redis/1-6/manual-br.html">v1.6</a>
                </li>
                <li>
                    <a href="http://docs.pivotal.io/redis/1-5/manual-br.html">v1.5</a>
                </li>
                <li>
                    <a href="http://docs.pivotal.io/redis/1-4/manual-br.html">v1.4</a>
                </li>
          </ul>
        </span>
      </span>

      <!-- search was here -->
    </div>
    <div class="local-header local-header-links">
    </div>
  </div>

          <h1 class="title-container" >
    Manual Backup and Restore of Redis for PCF
  </h1>

          <div id="js-quick-links" >
            <div class="quick-links"><ul>
<li><a href="#triggering">Triggering a Manual Backup</a></li>
<li><a href="#restore">Restore Redis Instance from a Backup</a></li>
<li><a href="#recovery">Recovering Redis Instances</a></li>
</ul></div>
          </div>
        <div class="to-top" id="js-to-top">
          <a href="#top" title="back to top"></a>
        </div>
        <h2><a id="triggering"></a>Triggering a Manual Backup</h2>

<p>Backups of your Redis deployment will automatically occur per the Cron Schedule you set in your deployment. You can trigger manual backups at any time by following the steps below. The backup artifacts will be sent to the destination configured in Ops Manager for automatic backups.</p>

<ul>
<li><a href="http://docs.pivotal.io/pivotalcf/customizing/trouble-advanced.html#ssh">Follow these steps</a> to log into your Ops Manager installation and target the Redis tile deployment.</li>
<li>Identify the VM which holds your instance by running <code>bosh vms</code>.

<ul>
<li>For the <code>shared-vm</code> plan this will be the job name containing <code>cf-redis-broker</code>. Running <code>manual-backup</code> will back up all of the shared-vm instances and the broker state in the <code>statefile.json</code> file.</li>
<li>For the <code>dedicated-vm</code> plan this will be the job name containing <code>dedicated-node</code>. Running <code>manual-backup</code> will back up the Redis dump.rdb file for that dedicated-vm instance.</li>
<li>You can identify the exact node for your <code>dedicated-vm</code> service instance by comparing the IP Address from your application bindings.</li>
</ul></li>
</ul>

<p>An example output from <code>bosh vms</code>:</p>

<p><img alt="OpsManager VMs view" src="bosh_vms.jpeg" /></p>

<ul>
<li>Target the manifest of your deployed Redis with <code>bosh deployment PATH-TO-MANIFEST.yml</code>. If you do not have this file, you can download it by running <code>bosh download manifest DEPLOYMENT-NAME</code>.</li>
<li><code>bosh ssh</code> into the node you wish to back up (or the <code>cf-redis-broker</code> node in a <code>shared-vm</code> plan).</li>
</ul>

<p>Once you have connected to the node, a manual backup can be triggered with these steps:</p>

<ol>
<li>Switch to root using <code>sudo -i</code>.</li>
<li>Run <code>/var/vcap/jobs/service-backup/bin/manual-backup</code></li>
</ol>

<h4>Notes</h4>

<p>Triggering a manual backup of a large dump.rdb could take sufficiently long that your SSH connection will timeout. Ensure that you have given yourself enough of a timeout to complete the backup.</p>

<p>Back ups are currently not available for On-Demand instances.</p>

<h2>Making Your Own Backups</h2>

<p>It is possible to create a back up of a Redis instance by hand, bypassing the automated backup tool altogether.</p>

<p>Persistence is enabled on these plans through the use of <code>RDB</code> files, using the following Redis config rules:
<pre class=terminal>
save 900 1
save 300 10
save 60 10000
</pre></p>

<h3>Shared-VM Plan</h3>

<p>You can either take the latest RDB file held on disk, which is generated by the above the rules, or trigger a recent update by using the <code>redis-cli</code> to trigger a <code>BGSAVE</code>. Credentials to log into the <code>redis-cli</code> can be obtained from <code>VCAP_SERVICES</code> for your bound application.</p>

<p>The <code>redis-cli</code> is located in <code>/var/vcap/packages/redis/bin/redis-cli</code>.</p>

<p>On this plan, the <code>BGSAVE</code> command is aliased to a random string. This can be obtained from Ops Manager in the credentials tab.</p>

<h4>Steps to Backup</h4>

<ol>
<li><code>bosh ssh</code> into your desired node. See the above section on <a href="#triggering">identifying the correct VM</a>.</li>
<li>Change to root using <code>sudo -i</code>.</li>
<li>Copy the contents of the <code>/var/vcap/store/cf-redis-broker</code> directory to a .zip or .tar file.</li>
<li>Backup the folder / compressed file to your chosen location.</li>
</ol>

<p>The <code>/var/vcap/store/cf-redis-broker</code> has sub-directories for each instance created of this plan. The backup file for each instance is called <code>dump.rdb</code>.</p>

<p>For example, here are two instances:
<pre class=terminal>
root@66358f3e-3428-46df-9bb3-9acc7770b188:/var/vcap/store/cf-redis-broker# find -type f | xargs ls -1
./redis-data/3124f373-e9e2-44e1-ad12-a8865d8978b0/db/dump.rdb
./redis-data/3124f373-e9e2-44e1-ad12-a8865d8978b0/redis.conf
./redis-data/3124f373-e9e2-44e1-ad12-a8865d8978b0/redis-server.pid
./redis-data/62333bf9-f023-4566-b233-6686f26b8f4d/db/dump.rdb
./redis-data/62333bf9-f023-4566-b233-6686f26b8f4d/redis.conf
./redis-data/62333bf9-f023-4566-b233-6686f26b8f4d/redis-server.pid
./statefile.json
</pre></p>

<h3>Dedicated-VM Plan</h3>

<p>You can either take the latest RDB file on disk, as generated by the above rules, or trigger a more recent RDB file by executing the <code>BGSAVE</code> command using the <code>redis-cli</code>. Credentials can be obtained from the <code>VCAP_SERVICES</code> from your bound application.
The <code>redis-cli</code> can be found in <code>/var/vcap/packages/redis/bin/redis-cli</code>.</p>

<h4>Steps to Backup</h4>

<ul>
<li><code>bosh ssh</code> into your desired node. See the above section on <a href="#triggering">identifying the correct VM</a>.</li>
<li>Change to root using <code>sudo -i</code>.</li>
<li>Copy the contents of the <code>/var/vcap/store/redis</code> directory to a .zip or .tar file.</li>
<li>Backup the folder / compressed file to your chosen location.</li>
</ul>

<p>The backup file will be named <code>dump.rdb</code>.</p>

<h2><a id="restore"></a>Restore Redis Instance from a Backup</h2>

<h3>To a Local System</h3>

<p>You can choose to restore the RDB file to a local Redis instance.</p>

<p>The steps to do this depend on your configuration and setup.
Refer to the <a href="http://redis.io/documentation">Redis documentation</a> for more details.</p>

<h3>To Pivotal Cloud Foundry</h3>

<p>You can also restore your backup file to another instance of the <code>Redis for PCF</code> tile.</p>

<h4>Prerequisites</h4>

<ul>
<li>Same resource configuration as the instance from which you backed up.</li>
<li>Ensure that the persistent disk is large enough to accommodate the temporary files used during the restore process. It should be <strong>3.5x the amount of RAM in the VM</strong>.</li>
</ul>

<p>To restore your backup file to another instance of a <code>Redis for PCF</code> tile service instance:</p>

<ol>
<li>Create a new instance of the plan that you wish to restore to.</li>
<li>Identify the VM which the instance of your plan is located on by following the steps from the <code>Manual Backups</code> section above. If you are restoring an instance of <code>shared-vm</code>, this VM is the broker VM.</li>
<li><code>bosh ssh</code> into the identified VM. This is the broker VM if restoring a <code>shared-vm</code> instance.</li>
</ol>

<p><code>Redis for PCF</code> version 1.7 and later provides a script to automatically restore data in a newly provisioned Redis instance.</p>

<h4>Preparation</h4>

<ol>
<li>Transfer your backup RDB file to a local path on the VM (<code>PATH-TO-RDB-BACKUP-ON-VM</code> has to be under <code>/var/vcap/store</code>.</li>
<li>To verify that the RDB file hasn&rsquo;t been corrupted, run <code>md5sum PATH-TO-RDB-BACKUP-ON-VM</code> and compare it against the contents of the <code>.md5</code> file named after the backup file. The values should be the same. The <code>.md5</code> file is located in the same bucket as the original backup file.</li>
<li>Switch to root user <code>sudo su</code></li>
</ol>

<h3>Dedicated-VM Plan</h3>

<p>The restore script will restore the data for the specified dedicated-vm instance.</p>

<h4>Execution</h4>

<ol>
<li>Run <code>/var/vcap/jobs/redis-backups/bin/restore --sourceRDB PATH-TO-RDB-BACKUP-ON-VM</code>.</li>
<li>Tail the script logs at <code>/var/vcap/sys/log/redis-backups/redis-backups.log</code> to see progress. When the data restore has been successfully completed, you will see the message <code>Redis data restore completed successfully</code>.</li>
</ol>

<h4>Debugging</h4>

<p>The data restore script runs the steps listed below. It logs its process along the way and provides helpful messages in case of failure.</p>

<p>The script logs at <code>/var/vcap/sys/log/redis-backups/redis-backups.log</code>. <br />
If a step has failed, resolve the reason that caused it to fail and execute the failed step and every next step manually.
You can retrieve <code>{instance_password}</code> through the binding to your service instance: <code>cf service-key {instance_name} {key_name}</code></p>

<ol>
<li><strong><code>StopAll</code></strong> <br />
Run <code>monit stop all</code></li>
<li><strong><code>WaitForStop</code></strong> <br />
Wait for monit services to enter the <code>not monitored</code> state, you can watch this with <code>watch monit summary</code></li>
<li><strong><code>DeleteExistingPersistenceFiles</code></strong> <br />
Clean up existing Redis data files:

<ul>
<li><code>rm -f /var/vcap/store/redis/appendonly.aof</code></li>
<li><code>rm -f /var/vcap/store/redis/dump.rdb</code></li>
</ul></li>
<li><strong><code>CopyBackupFileWithCorrectPermissions</code></strong> <br />
Restore your Redis backup file to <code>/var/vcap/store/redis/dump.rdb</code> and correct the owner and permissions with <code>chown vcap:vcap /var/vcap/store/redis/dump.rdb &amp;&amp; chmod 660 /var/vcap/store/redis/dump.rdb</code></li>
<li><strong><code>SetAppendOnly</code></strong> <br />
<code>Edit the template Redis config file with</code>vim $(find /var/vcap/data/jobs/ -name redis.conf)` and make the following line changes:

<ul>
<li> <code>appendonly yes</code> -&gt; <code>appendonly no</code></li>
</ul></li>
<li><strong><code>StartAll</code></strong> <br />
Run <code>monit start all</code></li>
<li><strong><code>WaitForStart</code></strong> <br />
Wait for monit services to enter the <code>running</code> state, you can watch this with <code>watch monit summary</code></li>
<li><strong><code>RewriteAOF</code></strong> <br />
Run <code>/var/vcap/packages/redis/bin/redis-cli -a {instance_password} BGREWRITEAOF</code></li>
<li><strong><code>RewriteAOF</code></strong> <br />
Run <code>watch &quot;/var/vcap/packages/redis/bin/redis-cli -a {instance_password} INFO | grep aof_rewrite_in_progress&quot;</code> until <code>aof_rewrite_in_progress</code> is <code>0</code></li>
<li><strong><code>StopAll</code></strong> <br />
Run <code>monit stop all</code></li>
<li><strong><code>WaitForStop</code></strong> <br />
Wait for monit services to enter the <code>not monitored</code> state, you can watch this with <code>watch monit summary</code></li>
<li><strong><code>ChownToUserAndGroup</code></strong> <br />
Set correct owner on <code>appendonly.aof</code> by running <code>chown vcap:vcap /var/vcap/store/redis/appendonly.aof</code></li>
<li><strong><code>SetAppendOnly</code></strong> <br />
Edit the template Redis config file with <code>vim $(find /var/vcap/data/jobs/ -name redis.conf)</code> and make the following line changes:

<ul>
<li> <code>appendonly no</code> -&gt; <code>appendonly yes</code></li>
</ul></li>
<li><strong><code>StartAll</code></strong> <br />
Run <code>monit start all</code></li>
</ol>

<h3>Shared-VM Plan</h3>

<p>The restore script will restore the data for the specified shared-vm instance.</p>

<h4>Execution</h4>

<ol>
<li>Retrieve <code>{instance_guid}</code> by running: <code>cf service {instance_name} --guid</code></li>
<li>Run <code>/var/vcap/jobs/redis-backups/bin/restore --sourceRDB {path-to-rdb-backup-on-vm} --sharedVmGuid {instance_guid}</code>.</li>
<li>Tail the script logs at <code>/var/vcap/sys/log/redis-backups/redis-backups.log</code> to see progress. When the data restore has been successfully completed, you will see the message <code>Redis data restore completed successfully</code>.</li>
</ol>

<h4>Debugging</h4>

<p>The data restore script runs the steps listed below. It logs its process along the way and provides helpful messages in case of failure.</p>

<p>The script logs at <code>/var/vcap/sys/log/redis-backups/redis-backups.log</code>. <br />
If a step has failed, resolve the reason that caused it to fail and execute the failed step and every next step manually.
You can retrieve <code>{instance_password}</code> and <code>{port}</code> through the binding to your service instance: <code>cf service-key {instance_name} {key_name}</code></p>

<ol>
<li><strong><code>StopAll</code></strong> <br />
Run <code>monit stop all</code></li>
<li><strong><code>WaitForStop</code></strong> <br />
Wait for monit services to enter the <code>not monitored</code> state, you can watch this with <code>watch monit summary</code></li>
<li><strong><code>SetConfigCommand</code></strong> <br />
Edit the template Redis config file with <code>vim /var/vcap/store/cf-redis-broker/redis-data/{instance_guid}/redis.conf</code> and comment out the line:

<ul>
<li><code>rename-command CONFIG &quot;configalias&quot;</code> -&gt; <code>#rename-command CONFIG &quot;configalias&quot;</code></li>
</ul></li>
<li><strong><code>SetRewriteCommand</code></strong> <br />
Edit the template Redis config file with <code>vim /var/vcap/store/cf-redis-broker/redis-data/{instance_guid}/redis.conf</code> and comment out the line:

<ul>
<li><code>rename-command BGREWRITEAOF &quot;&quot;</code> -&gt; <code>#rename-command BGREWRITEAOF &quot;&quot;</code></li>
</ul></li>
<li><strong><code>DeleteExistingPersistenceFiles</code></strong> <br />
Clean up existing Redis data files if they exist:

<ul>
<li><code>rm -f /var/vcap/store/cf-redis-broker/redis-data/{instance_guid}/db/appendonly.aof</code></li>
<li><code>rm -f /var/vcap/store/cf-redis-broker/redis-data/{instance_guid}/db/dump.rdb</code></li>
</ul></li>
<li><strong><code>CopyBackupFileWithCorrectPermissions</code></strong> <br />
Restore your Redis backup file to <code>/var/vcap/store/cf-redis-broker/redis-data/{instance_guid}/db/dump.rdb</code> and correct the owner and permissions with <code>chown vcap:vcap /var/vcap/store/cf-redis-broker/redis-data/{instance_guid}/db/dump.rdb &amp;&amp; chmod 660 /var/vcap/store/cf-redis-broker/redis-data/{instance_guid}/db/dump.rdb</code></li>
<li><strong><code>SetAppendOnly</code></strong> <br />
Edit the template Redis config file with <code>vim /var/vcap/store/cf-redis-broker/redis-data/{instance_guid}/redis.conf</code> and make the following line changes:

<ul>
<li> <code>appendonly yes</code> -&gt; <code>appendonly no</code></li>
</ul></li>
<li><strong><code>StartAll</code></strong> <br />
Run <code>monit start all</code></li>
<li><strong><code>WaitForStart</code></strong> <br />
Wait for monit services to enter the <code>running</code> state, you can watch this with <code>watch monit summary</code></li>
<li><strong><code>RewriteAOF</code></strong> <br />
Run <code>/var/vcap/packages/redis/bin/redis-cli -a {instance_password} BGREWRITEAOF</code></li>
<li><strong><code>RewriteAOF</code></strong> <br />
Run <code>watch &quot;/var/vcap/packages/redis/bin/redis-cli -a {instance_password} INFO | grep aof_rewrite_in_progress&quot;</code> until <code>aof_rewrite_in_progress</code> is <code>0</code></li>
<li><strong><code>StopAll</code></strong> <br />
Run <code>monit stop all</code></li>
<li><strong><code>WaitForStop</code></strong> <br />
Wait for monit services to enter the <code>not monitored</code> state, you can watch this with <code>watch monit summary</code></li>
<li><strong><code>ChownToUserAndGroup</code></strong> <br />
Set correct owner on <code>appendonly.aof</code> by running <code>chown vcap:vcap /var/vcap/store/redis/appendonly.aof</code></li>
<li><strong><code>SetAppendOnly</code></strong> <br />
Edit the template Redis config file with <code>vim /var/vcap/store/cf-redis-broker/redis-data/{instance_guid}/redis.conf</code> and make the following line changes:

<ul>
<li> <code>appendonly no</code> -&gt; <code>appendonly yes</code></li>
</ul></li>
<li><strong><code>SetConfigCommand</code></strong> <br />
Edit the template Redis config file with <code>vim /var/vcap/store/cf-redis-broker/redis-data/{instance_guid}/redis.conf</code> and uncomment the line:
<code>#rename-command CONFIG &quot;configalias&quot;</code> -&gt; <code>rename-command CONFIG &quot;configalias&quot;</code></li>
<li><strong><code>SetRewriteCommand</code></strong> <br />
Edit the template Redis config file with <code>vim /var/vcap/store/cf-redis-broker/redis-data/{instance_guid}/redis.conf</code> and uncomment the line:
<code>#rename-command BGREWRITEAOF &quot;&quot;</code> -&gt; <code>rename-command BGREWRITEAOF &quot;&quot;</code></li>
<li><strong><code>StartAll</code></strong> <br />
Run <code>monit start all</code></li>
</ol>

<h2><a id="recovery"></a>Recovering Redis Instances</h2>

<p>In the event of a recovery of Cloud Foundry, it is possible to recover bound
Redis instances to healthy states that are in sync with Cloud Foundry. There are
a few caveats to being able to recover previous instance state fully that
depend on your plan.</p>

<h3>Shared-VM Plan Caveats</h3>

<ul>
<li>You need a backed up RDB Redis dump file - this would be stored in your S3
buckets if you have backups configured</li>
<li>You need a backed up <code>/var/vcap/store/cf-redis-broker/redis-data</code> directory
from the service broker node (you do not need to backup and <code>*.aof</code> or
<code>*.rdb</code> files from subdirectories if you have backups configured)</li>
</ul>

<h3>Dedicated-VM Plan Caveats</h3>

<ul>
<li>You need a backed up RDB Redis dump file - this would be stored in your S3
buckets if you have backups configured</li>
<li>You need a backed up <code>/var/vcap/store/redis/statefile.json</code> from the service
broker node</li>
</ul>

<h3>Note</h3>

<p>This procedure assumes that a recovery of service information and service keys
assigned to instances are restored with a restore of Cloud Foundry.</p>

<h3>Recovery Procedure</h3>

<p>After redeploying Redis, take the following steps.</p>

<h4>Shared-VM Plan</h4>

<ol>
<li><code>bosh ssh</code> into the service broker node of your Redis deployment</li>
<li>Run <code>monit stop all &amp;&amp; pkill redis-server</code></li>
<li>Wait for monit services to enter the <code>not monitored</code> state, you can watch
this with <code>watch monit summary</code></li>
<li>Confirm no running instances of <code>redis-server</code> with
<code>ps aux | grep redis-server</code></li>
<li>Copy the backed up <code>redis-data</code> directory into <code>/var/vcap/store/cf-redis-broker</code></li>
<li>Follow the instructions <a href="#restore">here</a> for your plan, skipping the first
four steps described here, for restoring your backed up Redis data</li>
<li>Your Redis instance is now recovered</li>
</ol>

<h4>Dedicated-VM Plan</h4>

<ol>
<li><code>bosh ssh</code> into the service broker node of your Redis deployment</li>
<li>Run <code>monit stop all</code></li>
<li>Wait for monit services to enter the <code>not monitored</code> state, you can watch
this with <code>watch monit summary</code></li>
<li>Copy the backed up <code>/var/vcap/store/cf-redis-broker/statefile.json</code> and
ensure ownership and permissions are correct with
<code>chown vcap:vcap /var/vcap/store/redis/dump.rdb &amp;&amp; chmod 660 /var/vcap/store/redis/dump.rdb</code></li>
<li>Follow the instructions <a href="#restore">here</a> for your plan, skipping the first three steps
described here, for restoring your backed up Redis data</li>
<li>Your Redis instance is now recovered</li>
</ol>

        <div><a id='repo-link' href='http://github.com/pivotal-cf/docs-redis/tree/1.8/manual-br.html.md.erb'>View the source for this page in GitHub</a></div>

      </main>
    </div>
  </div>
</div>

<div id="scrim"></div>

<div class="container">
  <footer class="site-footer-links">
    <div class="copyright">
  <a href='http://pivotal.io/privacy-policy'>Privacy Policy</a> | 
  <a href='http://pivotal.io/terms-of-use'>Terms of Use</a><br/>
  <a href='/'>Pivotal Documentation</a>
  &copy; 2017 <a href='http://pivotal.io'>Pivotal Software</a>, Inc. All Rights Reserved.
</div>
<div class="support">
  Need help? <a href="http://support.pivotal.io" target="_blank">Visit Support</a>
</div>

  </footer>
</div><!--end of container-->

</body>
</html>
